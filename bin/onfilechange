#!/bin/bash

SCRIPTNAME=`basename "$0"`

print_help() {
	cat << EOF
Usage: $SCRIPTNAME FILE COMMAND
Run the given command whenever the given file changes.
EOF
}

# check dependencies
if ! type inotifywait &>/dev/null ; then
	echo "The library inotifywait is missing. Install the package inotify-tools."
	exit 1
fi

# parse arguments
if [ "$#" -gt 2 ]; then
    echo "Illegal number of parameters. Try '$SCRIPTNAME -h' for more information."
    exit 1
fi


# check help
for arg in "$@"
do
    if [ "$arg" == "--help" ] || [ "$arg" == "-h" ]
    then
        print_help
        exit 0
    fi
done

if [ "$#" -ne 2 ]; then
    echo "Illegal number of parameters. Try '$SCRIPTNAME -h' for more information."
    exit 1
fi

# all checks ok
FILE="$1"
COMMAND="$2"

if [ -f "$FILE" ]
then
    # actually do the wait-run loop
    while inotifywait -e close_write $FILE || true; do eval $COMMAND; done	
else
    # file does not exist
	echo "File '$FILE' does not exist."
fi

